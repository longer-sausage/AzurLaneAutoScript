name: Sync upstream and apply patch

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"   # 每 6 小时运行一次（UTC 时间）

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/LmeSzinc/AzurLaneAutoScript.git || git remote set-url upstream https://github.com/LmeSzinc/AzurLaneAutoScript.git
          git fetch upstream --prune

      - name: Reset master to upstream and apply patch
        run: |
          git checkout master
          git reset --hard upstream/master   # 如果上游默认分支是 main，把这一行改成 upstream/main

          # 应用补丁（冲突则直接失败，提醒你手动处理一次并更新 patch）
          git apply --3way --whitespace=nowarn patches/custom.patch

      - name: Commit if changed
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Sync upstream + apply custom patch"
          else
            echo "No changes after applying patch."
          fi

      - name: Push to fork
        run: |
          git push origin master
